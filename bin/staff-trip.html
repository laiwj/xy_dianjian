<xmp>

	<link href="../css/bootstrap-theme.min.css" rel="stylesheet">
	<!-- Prism -->
	<link href="../css/prism.css" rel="stylesheet">
	<link href="../css/footable.bootstrap.min.css" rel="stylesheet">

	<!--[if lt IE 9]>
	<script src="../js/html5shiv.min.js"></script>
	<script src="../js/respond.min.js"></script>
	<![endif]-->
<style type="text/css">
td{ text-align: center}
th{ text-align: center}
.lb{ cursor: pointer; padding: 5px; font-size: 13px; padding: 5px; border: 1px solid #ccc; margin-left: 2px }
.lbf{ cursor: pointer; padding: 2px 5px; font-size: 16px; border: 1px solid #ccc;  }
.activL{ background-color: #ccc }
.hide{display: none}
table tr th{background-color: #f0f0f2;border:1px solid #ccc}
table tr td{border:1px solid #ccc;}
table tfoot td{border:0px;}
</style>
<div class="m-sm bg-main">  
	<div class="hbox hbox-auto-xs hbox-auto-xs bg-white">
		<div class="col col-sm-12">
			<div class="title" id="unitsel2">出差流动分析</div>
            <div id="view2p" class="w-full" style="height:380px; padding-top:0px">
				<div style="height:42px; font-size: 12px;">
					<ul id="myTab" class="nav nav-tabs">
						<li class="active source"><a href="#出差统计" data-toggle="tab">出差统计</a></li>
						<li class="source"><a href="#流动地图" data-toggle="tab">流动地图</a></li>
					</ul>

				</div>
				<!--
				<div style="padding: 10px 0 0 20px; height: 40px">
					<label class="lb activL" id="v2lb1" style="cursor: pointer">出差统计</label>
					<label class="lb" id="v2lb2">流动地图</label>
					<div style="float: right; padding-right: 20px" >

					</div>
				</div>
				-->
				<div id="view2" style="height:340px;"></div>
				<div id="view3" class="hide" style="height:340px;"></div>
			</div>
		</div>
	</div>

	<div class="m-t-sm hbox hbox-auto-xs hbox-auto-xs bg-white bg-auto">
		<div class="col col-sm-12">
			<div class="title"></div>
			<div id="view4" class="w-full" style="height:430px; margin-bottom: 45px">
				<table id="table-data2" class="table" data-paging="true" data-sorting="false"></table>
			</div>
		</div>
	</div>
</div>


<script src="../js/bootstrap.min.js"></script>
<script src="../js/prism.js"></script>
<script src="../js/ie10-viewport-bug-workaround.js"></script>
<script src="../js/moment.min.js"></script>
<script src="../js/footable.min.js"></script>
<script src="../js/d3.v3.min.js"></script>
<script src="../js/timePiece.js"></script>
<script src="../js/echarts.v3.min.js"></script>
<script src="../js/datazoom.js"></script>
<script src="../js/china.js"></script>
<script src="../js/province.js"></script>

<script language="javascript">
"use strict";
var pieSelectName = "nosel";
var __myChart2 = null, __view1, __view2;
var __myChart3C = null, __myChart3P = null;
var __ChartDatazoom = null;
var __trip_data = null;
var __current_month = 0;
var __metux_view2 = false;
var __metux_load_map = false;
var __datazoom_view2 = null;
var __select_create = false;
var __trip_data_all = {};
var __init_datazoom = false;
var __current_view = 0;
var __current_unit = '';
var __view_map1 = null;
var __view_map2 = null;
var __trip_data_map = {};
var __trip_data_map_sum = {};

$(document).ready(function() {

	Init();

	//loadTripImage('view2');
	_loadMap('view2');
	getTripDataEx();
	getTripMapData();
	//getTripData('view2');

	function Init(){
		$('.form_date').datetimepicker({
			language:  'zh-CN', weekStart: 1, todayBtn:  1, autoclose: 1, todayHighlight: 1, startView: 2, minView: 2, forceParse: 0,
		}).on('changeDate', function(e){
			__metux_load_map = false;
			var startDate = $("#dtp_input2").val(), endDate = $("#dtp_input3").val();;
			getTripData(__view2, startDate, endDate);
			getTripDataEx(startDate, endDate, "所有部门");
			getTripMapData(startDate, endDate, "所有部门");
		});
		$('.form_date:eq(0)').datetimepicker('setDate', DateDSTD(init_trip_date_start));
		$('.form_date:eq(1)').datetimepicker('setDate', DateDSTD(init_trip_date_end));
		if(!__select_create){
			loadUnitList();
			__select_create = true;
		}
		$(".source").click(function(){
			var src = $(this).children("a:eq(0)").html();
			var funcs = {'出差统计':'loadBarView()', '流动地图':'loadMapView1()'};
			var ids = {'出差统计':['view2', 0], '流动地图':['view3', 1]}, temp = ['出差统计', '流动地图'];
			if($(this).hasClass('active'))return;
			$("#" + ids[src][0]).removeClass('hide');
			$("#" + ids[temp[(ids[src][1]^1)]][0]).addClass('hide');
			if(!__metux_load_map && src=="流动地图")
				__myChart3C = echarts.init(document.getElementById("view3")).showLoading();
			else{
				if(__myChart3P)__myChart3P.resize();
				if(__myChart3C)__myChart3C.resize();
			}
		});
	}
	function loadBarView(){ _loadMap('view2'); }
	function loadMapView1(){ loadMapImages(); }
	//---------------------------------加载部门信息----------------------------------------
	function selUnit2(_u){
		__current_view = 1;
		__current_unit = _u;
		loadTripImageUnit(__view2, __trip_data, __current_month, _u);
		loadTable2(__trip_data_all, "table-data2", _u)
	}
	function loadUnitList(){
		ajaxData('get_units', {}, function(data)
		{
			addUnitSel('unitsel2', data, selUnit2);
			$("#unitsel2sel1").val(init_unit_flow);
		});
	}
	//-------------------------------------------------------------------------------------

	function _loadMap(id){
		__init_datazoom = false;
		$("#"+ id).html("");
		$("#"+ id).css("background-color", "transparent");
		__datazoom_view2 = new Zoom(id);
		var lsm = range(0, 12).map(function(d){ return (d+1) + '月'; });
		var lsd = lsm.map(function(d){ return [d, 0]; });
		__datazoom_view2.loadZoom(lsd, _listenZoomMap1);
		__view2 = __datazoom_view2.did;
		__ChartDatazoom = __datazoom_view2.myChart;
		$("#" + __view2).css({'margin':'10','margin-left':0,'margin-right':10, 'margin-bottom':10 });
		getTripData(__view2);
	}
	function _listenZoomMap1(pos, val){
		if(__metux_view2)return; //防止重复触发事件
		__myChart2 = echarts.init(document.getElementById(__view2)).showLoading();
		__current_month = parseInt(val[0][0].toString().replace("月", ""))-1;
		if(__current_view==0 || __current_unit=="")loadTripImageAll(__view2, __trip_data, __current_month);
		else loadTripImageUnit(__view2, __trip_data, __current_month, __current_unit);
		if(__myChart2)__myChart2.hideLoading();
	}
	//------------------------------------------------------------------------------------------------------------------
	//***·一·**
	//主图数据
	function getTripData(id, dateStart, dateEnd){
		__myChart2 = echarts.init(document.getElementById(id)).showLoading();
		var startDate = $("#dtp_input2").val(), endDate = $("#dtp_input3").val();;
		dateStart = dateStart || startDate;
		dateEnd = dateEnd || endDate;

		var adt = {'dateStart':dateStart, 'dateEnd':dateEnd };
		ajaxData('get_trip', adt, function(data)
		{
			__trip_data = data['trip'];
			loadTripDefault();

			__metux_view2 = false;
			if(__myChart2)__myChart2.hideLoading();
		});
	}
	//表格数据
	function getTripDataEx(dateStart, dateEnd, _u){
		var startDate = $("#dtp_input2").val(), endDate = $("#dtp_input3").val();;
		dateStart = dateStart || startDate;
		dateEnd = dateEnd || endDate;
		_u = _u || "所有部门";

		var adt = {'dateStart':dateStart, 'dateEnd':dateEnd, 'unit':_u };
		ajaxData('get_trip_data', adt, function(data)
		{
			if(_u=='所有部门')__trip_data_all = data['data'];
			loadTable2(__trip_data_all, "table-data2", "所有部门")
		});
	}

	//--------------------------------------------------------------------------------------------------

	//-------------------------------------------------柱状图主要代码----------------------------------------------------------
	function getMonthPostion(m){ return [m/12*100, (m+1)/12*100]; }
	//***·二·**
	function loadTripDefault(){
		if(__myChart2)__myChart2.showLoading();
		var months = [], mall = [];
		__trip_data.forEach(function(d, i){
			mall.push(Object.keys(d).length);
			if(Object.keys(d).length>0)months.push(i);
		} );
		__datazoom_view2.setData(mall);
		loadTripImageAll(__view2, __trip_data, months[0]);
		if(__myChart2)__myChart2.hideLoading();
		loadTable2(__trip_data_all, "table-data2", "所有部门")
	}
	//***·三·**
	function getOptionBar(x, data, style){
		var colorStyle = [{offset: 0, color: '#EE8262'}, {offset: 0.5, color: '#EE8262'}, {offset: 1, color: '#EE8262'}];
		if(!style) colorStyle = [{offset: 0, color: '#83bff6'}, {offset: 0.5, color: '#188df0'}, {offset: 1, color: '#188df0'}];
		var maxY = data.reduce(function(a, b){ return a>b ? a : b; }, 1) + 1;
		return {
			tooltip : {},
			grid: { x:35, x2:15, y:10, y2:40 },
			xAxis : [ { type : 'category', data : x, axisLabel: { interval:0, rotate:45,
				formatter: function (name) { return echarts.format.truncateText(name, 45, '12px Microsoft Yahei', '…'); }, tooltip: { show: true }}  } ],
			yAxis: [{ max:maxY, nameGap:25, name:"频次", nameLocation:"middle", axisTick: { show: false }, axisLabel: { textStyle: { color: '#999' } } }],
			dataZoom: [ { type: 'inside' } ],
			series: [{
				type: 'bar', data: data, label: {normal: {show: true, position: 'insideTop'}}, barMaxWidth:120,
				itemStyle: {normal: { color: new echarts.graphic.LinearGradient( 0, 0, 0, 1, colorStyle )}}
			}]
		};
	}
	//*通用加载过程*
	function loadTripImage(id, _dt, month, units, data, viewIndex, clickF) {
		__metux_view2 = true;
		__current_view = viewIndex;
		month = month || __current_month;
		if(!data || data.length==0){ __myChart2 = Init3(getOptionBar(['暂无数据'], []), id); __metux_view2 = false; return; }
		var option = getOptionBar(units, data, __current_view);
		__myChart2 = Init3(option, id);
		__myChart2.on('click', clickF);
		if(!__init_datazoom){
			__ChartDatazoom.dispatchAction({type: 'dataZoom', dataZoomIndex: 0, start: getMonthPostion(month)[0], end: getMonthPostion(month)[1]});
			__init_datazoom = true;
		}
		__current_month = month;
		__metux_view2 = false;
	}
	//加载所有部门信息
	function loadTripImageAll(id, data, month){
		month = month || __current_month;
		var _data = __trip_data[month];
		var units = Object.keys(_data), data = units.map(function(u){ return values(_data[u]).reduce(function(a, b){ return a + b;}, 0); });
		loadTripImage(id, data, month, units, data, 0, function(p){ if(p.seriesType!='bar')return; selUnit2(p.name); });
	}
	//加载指定部门信息
	function loadTripImageUnit(id, data, month, _unit){
		month = month || __current_month;
		if(_unit==public_all_unit)return loadTripImageAll(id, data, month);
		var _data = __trip_data[month][_unit];
		if(!_data){	Init3(getOptionBar(['暂无数据'], []), id); __metux_view2 = false; return; }
		var persons = Object.keys(_data), data = persons.map(function(p){ return _data[p]; });
		loadTripImage(id, data, month, persons, data, 1, function(p){
			if(p.seriesType!='bar')return;

		});
	}
	//-----------------------------------------------------------------------------------------------------------





	//-------------------------------------------------表格2---------------------------------------------
	function formatDataTable2(_dt, _unit){
		function formatStr(str){ return (str.length>21)?str.substr(0, 21)+'...':str}
		var dt = [];
		for(var u in _dt){
			if(_unit!=undefined && _unit!='所有部门' && _unit!=u )continue;
			for(var k in _dt[u])dt.push({"id":k, "name":_dt[u][k].name, "unit":u,
					"dates":formatStr(_dt[u][k].dates.join(",")), "counts":_dt[u][k].dates.length});
		};
		dt.sort(function(a, b){ return b.counts - a.counts; });
		return dt;
	}
	function loadTable2(data, tbId, _unit){
		$('#'+tbId).html("");
		var columns = [
			{"name":"id","title":"ID", "visible":false},//,"style":{"width":80,"maxWidth":80}},
			{"name":"name","title":"姓名"},
			{"name":"unit", "title":"部门"},
			{"name":"dates","title":"出差日期", "breakpoints":"xs sm"},
			{"name":"counts", "title":"累计频次", "type":"number", "visible":true},
		];
		var ft = $('#'+tbId).footable({
			"columns": columns, "rows": formatDataTable2(data, _unit), "paging": { "size": 8 },
		});
		tableClick(ft, tbId);
	}

	//--------------------------------------------地图相关---------------------------------------------------------
	function InitMapViews(id){
		var $p = $("#"+id);
		$p.html("");
		__view_map1 = id + 'map1';
		__view_map2 = id + 'map2';
		$p.append('<div id="'+ __view_map1 +'" style="float:left;width:50%; height:100%"></div>');
		$p.append('<div id="'+ __view_map2 +'" style="float:left;width:50%; height:100%"></div>');
	}
	//获取地图数据
	function getTripMapData(dateStart, dateEnd, _u, display){
		__myChart3C = echarts.init(document.getElementById("view3")).showLoading();
		var startDate = $("#dtp_input2").val(), endDate = $("#dtp_input3").val();;
		dateStart = dateStart || startDate;
		dateEnd = dateEnd || endDate;
		_u = _u || "所有部门";

		var adt = {'dateStart':dateStart, 'dateEnd':dateEnd, 'unit':_u };
		ajaxData('get_trip_map', adt, function(data)
		{
			__metux_load_map = true;
			if(__myChart3C)__myChart3C.hideLoading();
			if(_u=='所有部门')__trip_data_map = data['data'];
			cout("map data ok.");
			//cout(data);

			loadMapImages(_u);
		});
	}
	function loadMapImages(_u){
		_u = _u || $("#unitsel2sel1").val();
		InitMapViews('view3');
		var _udt = __trip_data_map.hasOwnProperty(_u) ? __trip_data_map[_u] : {};
		if(_u=='所有部门')_udt = __trip_data_map_sum = sumUnitData(__trip_data_map);
		var top10 = getTop10(_udt);
		loadMapMove(__view_map1, top10);
		if(top10.length==0)top10 = [[['北京市', '北京市'], 0]];
		//top10 = [[['北京市', '北京市'], 0]];
		//top10 = [[['陕西省', '西安市'], 0]];
		cout(top10[0]);
		showProvince(__view_map2, top10[0][0][0]);
	}
	//部门综合
	function sumUnitData(_dt){
		var sumD = {};
		for(var u in _dt){
			for(var p in _dt[u]) {
				if(!sumD.hasOwnProperty(p)) sumD[p]= { "name":p, "value":0, "children":{} };
				sumD[p].value += _dt[u][p].value;
				for(var c in _dt[u][p].children) {
					if(!sumD[p].children.hasOwnProperty(c)) sumD[p].children[c]= { "name":c, "value":0, "children":{} };
					sumD[p].children[c].value += _dt[u][p].children[c].value;
				}
			}
		}
		return sumD;
	}
	function getTop10(_dt){
		var data = [];
		var tp = values(_dt).sort(function(a, b){ return b.value- a.value; });
		for(var i=0; i<tp.length; i++){
			if(data.length>=10)break;
			if(tp[i].name=="四川省" || tp[i].name=="国外" )continue
			if(Object.keys(tp[i].children).length==0){
				var p = getCapital(tp[i].name);
				data.push([[p, p], tp[i].value]);
			}
			else{
				var ps = values(tp[i].children).sort(function(a, b){ return b.value- a.value; })[0];
				data.push([[tp[i].name, ps.name], ps.value]);
			}
		}
		return data;
	}
	function showProvince(id, p) {
		$("#" + id).html("");
		var name = mapToProvince(p), city = getProvinceCapital(name);
		var temp = {}, dData = [], maxV = 5, _pcd = {};
		var key = (p in {'北京':1, '上海':1, '天津':1, '重庆':1}) ? p+"市" : name;
		/* 数据中直辖市以市的形式出现 */

		if (__trip_data_map_sum.hasOwnProperty(key)) {
			temp = __trip_data_map_sum[key];
			dData = items(temp.children).map(function (d) {
				var c = d[0].replace("市", "");
				if(maxV<d[1].value)maxV = d[1].value;
				var _rst = {name: c, value: getProvince(temp.name)['citys'][d[0]][d[0]].concat(d[1].value)};
				if(p in {'北京':1, '上海':1, '天津':1, '重庆':1})_rst['value'][2] = temp.value;
				_pcd[c] = _rst['value'][2];
				return _rst;
			});
		}
		if(dData.length==0)dData.push({name:city[0], value:[city[1], city[2], 1]});
		var scaleS = function(v){ return Math.ceil(13 * v / maxV); }
		// myChart.showLoading();

		$.get('../json/map/' + name + '.json', function (geoJson) {
			// myChart.hideLoading();
			echarts.registerMap(name, geoJson);
			var option = {
				backgroundColor: '#D9B3B3',
				tooltip: { trigger: 'item', formatter:function(p){return p.name + " " + ((_pcd.hasOwnProperty(p.name)) ? _pcd[p.name]: 0) + "次"; } },
				title: { text: p, left: 'center', textStyle: { color: '#fff' } },
				geo: { map: name, roam: true, label: { emphasis: { show: false } }  },
				series: [
					{//rippleEffect: { brushType: 'stroke'},
						type: 'effectScatter', coordinateSystem: 'geo', mapType: name, zlevel: 5,
						label: { normal: { show: true, position: 'right', formatter: '{b}' }  },
						itemStyle: {
							normal: { borderColor: '#389BB7', areaColor: '#fff', },
							emphasis: { areaColor: '#389BB7', borderWidth: 0 }
						},
						data:dData,
						animation: false,symbolSize: function (val) { return scaleS(val[2]); }
					}
				]
			};
			__myChart3C = Init3(option, id);
			__myChart3C.on('mouseover', function(p){
				$("#").tooltip();
				cout(p);
			});
			if(__myChart3C)__myChart3C.hideLoading();
		});
	}

function loadMapMove(id, _dt) {
	var _pCache = {}, pDsp = {"新疆维吾尔自治区":1, "西藏自治区":1, "云南省":1, "内蒙古自治区":1, "青海省":1}, _pcd = {};
	var pData = _dt.map(function(d){
		return {fromName:'成都', toName:d[0][1], coords:[[104.07, 30.67], getProvince(d[0][0])['citys'][d[0][1]][d[0][1]]]};
	});
	var dData = _dt.map(function(d){
		var c = d[0][1].replace("市", "");
		_pcd[c] = d[1];
		return {name: c, value:getProvince(d[0][0])['citys'][d[0][1]][d[0][1]].concat(d[1])};
	});
	var planePath = 'path://M1705.06,1318.313v-89.254l-319.9-221.799l0.073-208.063c0.521-84.662-26.629-121.796-63.961-121.491c-37.332-0.305-64.482,36.829-63.961,121.491l0.073,208.063l-319.9,221.799v89.254l330.343-157.288l12.238,241.308l-134.449,92.931l0.531,42.034l175.125-42.917l175.125,42.917l0.531-42.034l-134.449-92.931l12.238-241.308L1705.06,1318.313z';
	var color = ['#a6c84c', '#ffa022', '#46bee9'];
	var maxV = _dt.length==0 ? 1 : _dt[0][1];
	var scaleS = function(v){ return Math.ceil(13 * v / maxV); };
	var option1 = {
		backgroundColor: '#404a59',
		title: { text: '出差流动', subtext: '电建集团', left: 'center', textStyle: { color: '#fff' }},
		tooltip: { trigger: 'item', formatter:function(p){
			if(p.componentSubType=="lines")return;
			return p.name + " " + ((_pcd.hasOwnProperty(p.name)) ? _pcd[p.name]: 0) + "次"; } },
		legend: { orient: 'vertical', top: 'top', left: 'right',
			data: ['成都 Top10'], textStyle: { color: '#fff' },  selectedMode: 'single'
		},calculable: false,
		geo: {
			map: 'china', roam: true, label: { emphasis: { show: true } },
			itemStyle: { normal: { areaColor: '#323c48', borderColor: '#404a59' },  emphasis: { areaColor: '#3f338d' }}
			//itemStyle: { normal: { areaColor: '#323c48', borderColor: '#404a59' },  emphasis: { areaColor: '#2a333d' }}
		},
		series: [{
			name: 'Top10', type: 'lines', zlevel: 2, data: pData,
			effect: { show: true, period: 6, trailLength: 0, symbol: planePath, symbolSize: 15 },
			lineStyle: { normal: { color: color[0], width: 1, opacity: 0.4, curveness: 0.2 } },
		}, {
			name: 'Top10', type: 'effectScatter', coordinateSystem: 'geo', zlevel: 2,
			rippleEffect: { brushType: 'stroke' }, data: dData,
			label: { normal: { show: true, position: 'right', formatter:
			function(p){ return (p.name.length>2 && !pDsp.hasOwnProperty(_pCache[p.name])) ? p.name.substr(0,2)+"." : p.name;}  } },
			symbolSize: function (val) { return scaleS(val[2]); },
			itemStyle: { normal: { color: color[0] } },
		}]
	};
	cout(option1);
	__myChart3P = Init3(option1, id);
	__myChart3P.on('click', function(p){
		if(p.componentType!='geo')return;
		showProvince(__view_map2, p.name);

	});

	//$("#" + id).css('background-color', '#fff');
}
});


/*
//堆积图 - 主要代码
function loadTripImage2(id, _data, page, month){
	__metux_view2 = true;
	month = month || __current_month;
	page = page || __current_page;
	_data = __trip_data[month];
	var units = Object.keys(_data), lg = [], mid = parseInt(units.length/2);
	//units = (page==0) ? units.slice(0, mid) : units.slice(mid-1, units.length);
	var temp = units.map(function(d){
		var lstp = [];
		for(var k in _data[d]){
			lstp.push(_data[d][k]);
			lg.push([k, d, _data[d][k]]);
		}
		return lstp;
	});
	var data = lg.map(function(d, i){
		return { name:d, type:'bar', stack:lg[0], data:units.map(function(rd){ return rd==d[1] ? d[2] : 0; }) }
	});
	var max = temp.reduce(function(a, b){ var e=b.reduce(function(c, d){ return c+d; }, 0); return a>e ? a : e  }, 0) ;
	var option = {
		tooltip : { axisPointer:{ type : 'shadow' }, formatter:function(p){
			return p.seriesName.split(',')[0] + ' : ' + p.data + '次<br/>' + p.name;
		}},
		grid: { x:30, x2:15, y:10, y2:40 },
		calculable : true,
		xAxis : [ { type : 'category', data : units, axisLabel: { interval:0, rotate:45,
			formatter: function (name) { return echarts.format.truncateText(name, 45, '12px Microsoft Yahei', '…'); }, tooltip: { show: true }}  } ],
		yAxis : [ { type : 'value' } ],
		series : data
	};
	__myChart2 = Init3(option, id);
	//设置时间轴位置
	__ChartDatazoom.dispatchAction({
		type: 'dataZoom', dataZoomIndex: 0, start: getMonthPostion(month)[0], end: getMonthPostion(month)[1]
	});
	__current_month = month;
	__metux_view2 = false;
}
*/
</script>
</xmp>