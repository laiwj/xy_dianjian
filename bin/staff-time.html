<xmp>

	<link href="../css/bootstrap-theme.min.css" rel="stylesheet">
	<!-- Prism -->
	<link href="../css/prism.css" rel="stylesheet">
	<link href="../css/footable.bootstrap.min.css" rel="stylesheet">

	<!--[if lt IE 9]>
	<script src="../js/html5shiv.min.js"></script>
	<script src="../js/respond.min.js"></script>
	<![endif]-->
<style type="text/css">


</style>
<div class="m-sm bg-main">  
	<div class="hbox hbox-auto-xs hbox-auto-xs bg-white">
		<div class="col col-sm-6 p-n">
			<div class="title" id="unitsel1">工作时间分析</div>
            <div id="view1" class="w-full" style="height:380px"></div>
		</div>
		<div class="col col-sm-6">
			<div class="title">工作时间统计</div>
            <div id="view2" class="w-full p-l-sm" style="height:380px; padding-top:6px">
				<table id="table-data1" class="table" data-paging="true" data-sorting="true"></table>
			</div>
		</div>
	</div>

	<div class="m-t-sm hbox hbox-auto-xs hbox-auto-xs bg-white bg-auto">
		<div class="col col-sm-12">
			<div class="title">数据详情</div>
            <div id="view3" class="w-full" style="height:380px; ">
				<table id="table-data2" class="table" data-paging="true" data-sorting="true"></table>
			</div>
		</div>
	</div>
	<!--
	<div class="m-t-sm">
		<div class="hbox hbox-auto-xs hbox-auto-xs bg-white">       
			<div class="col w-full bg-light lter bg-auto">
				<div class="title">数据视图</div>
				<div id="view5" style="width:100%;min-height:400px">
					<table id="table-data" class="table" data-page-size="4" data-paging="true"  data-filtering="true" data-sorting="true"></table>
				</div>
			
			</div>
		</div>	
	</div>
	-->
</div>
	<script src="../js/echarts.min.js"></script>
<script src="../js/jquery-1.9.1.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/prism.js"></script>
<script src="../js/ie10-viewport-bug-workaround.js"></script>
<script src="../js/moment.min.js"></script>
<script src="../js/footable.min.js"></script>
<script src="../js/d3.v3.min.js"></script>
<script src="../js/highcharts.js"></script>

<script language="javascript">
"use strict";
var pieSelectName = "nosel";
var units = [];
var __myChart1 = null;
var maxY = -1;
$(document).ready(function() {

	//function DateF(date){ return parseInt(date/60 + 5) + ":" + parseInt(date % 60); }
	//loadTimes();


	loadUnitList();
	loadPersonTime('view2');

	loadOnlineDataByUnit();

	//----------------------加载部门信息
	function loadUnitList(){
		ajaxData('get_units', {}, function(data)
		{
			units = data;
			addUnitSel('unitsel1', data, loadOnlineDataByUnit);
			//addUnitSel('unitsel2', data, selectUnitInterval);
			$("#unitsel1sel1 option:first").remove();
			$("#unitsel1sel1").val(init_unit_online);
		});
	}
	//-----------------------------------------------------------------------------
	function loadOnlineDataByUnit(_u){
//		if(_u==undefined)_u = $("#unitsel1sel1").val() ;
//		var datesel = getDateByMonth($("#pheadsel1").val()), //dateEnd = $("#pheadsel2").val();
//				dateStart = datesel.dateStart || init_date_start, dateEnd = datesel.dateEnd || init_date_end;
		__myChart1 = echarts.init(document.getElementById("view1")).showLoading();
		_u = _u || init_unit_online;
		var dateStart = init_date_start, dateEnd = init_date_end;
		dateStart = "2015-02-02"; dateEnd = "2016-11-02";
		var adt = {'dateStart':dateStart, 'dateEnd':dateEnd, 'unit':_u};
		ajaxData('get_online_unit', adt, function(data)
		{
			//__flow_data = data['data'];
			cout(data.unit);
			var dt = data.unit;
			for(var u in dt){
				var ls = {};
				var p = Math.random();
				for(var i=0;i<1436;i++ ){
					if(Math.random()<0.3)continue;
					var p1 = 1;
					if(i>100 && i<350)p1 = 0.1;

					if(i>350 && i<400)p1 = 0.15;
					if(i>400 && i<450)p1 = 0.2;

					if(i>450 && i<500)p1 = 0.25;

					if(i>500 && i<550)p1 = 0.3;

					if(i>550 && i<600)p1 = 0.35;

					if(i>600 && i<800)p1 = 0.8;
					if(i>800 && i<850)p1 = 0.6;
					if(i>850 && i<1200)p1 = 0.9;
					if(i>1200 && i<1430)p1 = 0.5;
					var v = parseInt(Math.random()*50 + 10);
					v = v*p1*p;
					ls[i] = parseInt(v);

					//ls[v] = parseInt(Math.random()*2);
					//else ls[v] = parseInt(Math.random()*20);
				}
				dt[u] = ls;
			}

			loadTimes(data.unit, {'level':'unit', 'name':_u }, data.scale, data.maxCount);
			loadTable(data.person, _u);
			//loadTimes();
			__myChart1.hideLoading();
		});
	}
	function loadOnlineDataByPerson(_person, _name){
//		if(_u==undefined)_u = $("#unitsel1sel1").val() ;
//		var datesel = getDateByMonth($("#pheadsel1").val()), //dateEnd = $("#pheadsel2").val();
//				dateStart = datesel.dateStart || init_date_start, dateEnd = datesel.dateEnd || init_date_end;
		__myChart1 = echarts.init(document.getElementById("view1")).showLoading();
		var dateStart = init_date_start, dateEnd = init_date_end;
		dateStart = "2015-02-02"; dateEnd = "2016-11-02";
		var adt = {'dateStart':dateStart, 'dateEnd':dateEnd, 'person':_person};
		ajaxData('get_online_person', adt, function(data)
		{
			loadTimes(data.data, {'level':'person', 'pid':_person, 'name':_name }, data.scale, data.maxCount);
			__myChart1.hideLoading();
		});
	}
	//上网数据规范化·需要
	function formatDataTimes(scale, data){
		var fmt = {}, x=[], flag = false, maxY = 0;
		for(var t in data){
			fmt[t] = []
			for(var i=0; i<1440; i+=scale){
				if(!flag)x.push(TimeMTS(i));
				fmt[t].push(data[t].hasOwnProperty(i) ? data[t][i] : 0);
			}
			flag = true;
		}
		return {x:x, data:fmt, maxValue:maxY };
	}
	function loadTimes(data, opt, scale, maxC) {
		var fmt = formatDataTimes(scale, data), maxY = parseInt(maxC);;
		var dt = fmt.data, x = fmt.x;
		var lstp = Object.keys(dt);
		var ses = Object.keys(dt).map(function (d) {
			return {
				name: d, type: 'line', areaStyle: {normal: {}}, //smooth: true, //stack: '总量',
				data: dt[d]//.sort(function(a, b){ return parseInt(a[0])>parseInt(b[0]); })//source[d].reduce(function (a, b) { a.push(b[1]); return a; }, [])
			};
		});
		lstp.unshift('');
		lstp.unshift('');
		cout(ses);
		var title = ' '+ (opt.level=='unit' ? '部门：' + opt.name : '员工：'+opt.name) + '时间分布';
		var option = {
			title: {text: title, textStyle:{fontSize: 12}},
			tooltip: {trigger: 'axis', //formatter :function(c){ cout(c); return c.seriesName + "<br />" + TimeMTS(c.data[0]) + " " + c.data[0] + "次";}
				//formatter : '{a0}<br />{b0}: {c0}次<br />'
			},
			legend: {data: lstp},
			grid: {left: '3%', right: '4%', bottom: '3%', containLabel: true},
			xAxis: [{type: 'category', boundaryGap: false, min:'auto', data:x,
				}],
			yAxis: [{type: 'value'}],
			series: ses
		};
		__myChart1 = Init3(option, 'view1');
		__myChart1.dispatchAction({ type: 'legendUnSelect', name: '其它' })
	}

	//--------------------------------------图2------------------------------------------
	function loadPersonTime(id){
		$('#' + id).highcharts({
			chart: { type: 'bar', marginLeft:25 },
			title: { text: '李**时间统计' },
			subtitle: { text: '' },
			xAxis: {
				categories: [''],
				title: { offset:12, rotation: 270, text: '时间统计', style:{'fontSize':'15px'} }
			},
			yAxis: {
				min: 0, lineWidth: 1,
				title: { text: '时长 (单位：小时)', align: 'high' },
				labels: { overflow: 'justify' }
			},
			tooltip: { valueSuffix: ' h' },
			plotOptions: { bar: { dataLabels: { enabled: true } } },
			legend: {
				layout: 'vertical', align: 'right', verticalAlign: 'top',
				x: -15, y: 60, floating: true, borderWidth: 1, shadow: true,
				backgroundColor: ((Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF')
			},
			credits: { enabled: false },
			series: [{ name: '会议', data: [1.2]},
			{ name: '看电影', data: [1.5]},
			{ name: '收发邮件', data: [0.7]},
			{name: '玩游戏', data: [2]},
			{ name: '上网', data: [4.5]}
			]
		});	
	}
	//---------------------------------表格相关----------------------------------------
	function formatDataTable(person, _u){
		var dt = [];
		for(var pid in person){
			dt.push({"id":pid, "name":person[pid]['name'], "unit": _u, "flux":0,
				"counts":person[pid]['sum'], "types":person[pid]['types'].join("、") });
		}
		return dt;
	}
	function loadTable(data, _u){
		$('#table-data2').html("");
		var columns = [
			{"name":"id", "title":"ID", "visible":true},
			{"name":"name","title":"姓名","breakpoints":"xs sm"},//,"style":{"width":80,"maxWidth":80}},
			{"name":"unit", "title":"部门", "breakpoints":"xs sm"},
			{"name":"flux","title":"访问流量", "type":"number"},
			{"name":"counts", "title":"访问频次", "type":"number"},
			{"name":"types", "title":"访问内容分类"}
		];
		$('#table-data2').footable({
			"columns": columns, "rows": formatDataTable(data, _u),
			"paging": { "size": 8 },
		});
		$('#table-data2 tbody tr').click(function(e){
			var pid = $(this).find("td").first().html(), name = $(this).find("td:eq(1)").html();
			$('#table-data2 tbody tr').css("background-color", '');
			$('#table-data2 tbody tr').css("color", '');
			$(this).css("background-color", "#FFF8D7");
			$(this).css("color", "green");
			loadOnlineDataByPerson(pid, name);
		});

	}
	
});

</script>
</xmp>