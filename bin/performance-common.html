<xmp>
    <meta charset=utf-8>

    <link rel="stylesheet" href="../css/bootstrap-treeview.min.css" type="text/css" />
    <link href="../css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Prism -->
    <link href="../css/prism.css" rel="stylesheet">
    <link href="../css/footable.bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/colorbox.css" />

    <!--[if lt IE 9]>
    <script src="../js/html5shiv.min.js"></script>
    <script src="../js/respond.min.js"></script>
    <![endif]-->

    <style type="text/css">
        th,td{ border: 1px solid #CCCCCC; background-color: white; height: auto; min-height: 30px}
        #table1 li{ height: 30px; border-bottom: 1px solid #ddd; border-right: 0px;border-left: 0px  }
        #table1 ul{ border-top: 0px }
        .pointer{cursor: pointer}

        .key-add{color:#5cb85c}
        .key-del{color:red}
        .key-edit{color:#31b0d5}
        tr>td>div.newParent>span.badge{color:#5cb85c; cursor: pointer}
        div.treeview>ul>li>span.badge:nth-last-child(1){color:#5cb85c }
        div.treeview>ul>li>span.badge:nth-last-child(2){color:red }
        div.treeview>ul>li>span.badge:nth-last-child(3){color:#31b0d5 }

        th{ text-align: center; height: 30px}
        tr td{ min-width: 40px; }
        tr td:first-child{ text-align: center;}
        tr td.treeview{text-align: left}
        .hide{display: none}
        .td_value{ width: 100%;border-right: 0px; border-bottom:1px solid #ccc; height:29px; padding-top:10px;text-align: center;  }
        .newParent{padding-bottom: 8px; margin-top: 8px; padding-left: 38px;}
        #table2 tr td{  border:0px; padding-top: 8px}
        #table1>tr>th:first-child{ max-width: 120px; }
        #table1>tr>td:first-child{ max-width: 120px; }

    </style>
    <div class="m-sm bg-main">
        <div class="m-t-sm hbox hbox-auto-xs hbox-auto-xs bg-white bg-auto" style="margin-top:5px; margin-bottom: 45px">
            <div class="col col-sm-12">
                <div class="title">全局指标设定</div>
                <div id="view" class="w-full" style="min-height:395px; height: auto;">
                    <table id="table1" style="width: 100%; margin-bottom: 60px">

                    </table>
                </div>
            </div>

        </div>
    </div>


    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/bootstrap-3.3.7.min.js"></script>
    <script src="../js/bootstrap-treeview.min.js"></script>
    <script src="../js/public.js"></script>
    <script src="../js/prism.js"></script>
    <script src="../js/ie10-viewport-bug-workaround.js"></script>
    <script src="../js/moment.min.js"></script>
    <script type="text/javascript" src="../js/jquery.colorbox-min.js" ></script>
    <script src="../js/com_tree.js"></script>


    <script id="tm_table1" type="text/html">
        <tr>
            <th>绩效因素</th>
            <th>权值</th>
        </tr>

        <tr>
            <td id="key_common" valign="top">
                <div id="tree99999p0"></div>
                <div id="new99999p0" class="newParent">
                    <span class="badge">✛</span>
                </div>
            </td>
            <td id="value_common" valign="top">
                <div>
                    <% for(var i=0; i<d.treeList.length; i++){ %>
                    <div id="ys<%= d.treeList[i][0] %>" class="td_value"><%= d.treeList[i][2] %>%</div>
                    <% } %>
                </div>
            </td>
        </tr>

    </script>
    <script id="tm_edit1" type="text/template">
        <div style="margin: 20px">
            <div style="border: 1px solid #ccc; padding: 20px; margin-right: 7px; padding-top: 10px">
                <table id="table2">
                    <tr>
                        <td colspan="6" style="text-align:left; font-weight: 600">
                            <input type="radio" name="ys_edit" id="radio_edit0" value="0" />
                            <span id="lbEdit0" class="pointer label label-primary"> 添加自定义因素</span>
                        </td>
                    </tr>
                    <tr>
                        <td></td><td>名称：</td><td><input type="text" id="edit_name0" class=""></td><td> </td><td>权重：</td>
                        <td><select id="edit_value0"><option>10%</option><option>20%</option></select></td>
                    </tr>
                    <tr height="18px"><td colspan="6"></td></tr>

                    <tr>
                        <td colspan="6" style="text-align:left; font-weight: 600">
                            <input type="radio" checked="checked" name="ys_edit" id="radio_edit1" value="1" />
                            <span id="lbEdit1" class="pointer label label-primary"> 添加系统因素</span>
                        </td>
                    </tr>
                    <tr>
                        <td></td><td>名称：</td><td><select id="edit_name1"><option>加班时间</option></select></td><td> </td><td>权重：</td>
                        <td><select id="edit_value1"><option>10%</option><option>20%</option></select></td>
                    </tr>
                </table>
            </div>

            <div style="margin-bottom: 40px; width: 100%; min-height: 30px; clear: both; padding-top: 14px; padding-right: 7px">
                <div class="floatR">
                    <button type="button" class="btn btn-primary" id="btnAddSubmit"> 提交 </button>
                </div>
            </div>
            <input type="text" id="treeIdValue" style="display: none" value="<%= treeId %>" />
            <input type="text" id="nodeIdValue" style="display: none" value="<%= nodeId %>" />
        </div>
    </script>

    <script language="javascript">
        "use strict";
        var units = [];
        var __lsOther = {};
        var $pl;
        var __tempc = null;
        //var __common = [];
        //var __common_index = {};
        //var __treeview_data = {};       //save all data here.
        var TV = new ViewTree();
        ViewTree.__common_style = 1;
        ViewTree._after_change = loadTreeData;


        /*
        function clickNodeForOperate(e){
            var treeId = $(this).parents("div.treeview").attr('id');
            var nodeId = $(this).parent().find("a").attr("href").replace("#node-", "");
            var lb = $(this).html();        //['✎', '✕', '✛'];
            var data = __treeview_data[treeId];

            if(lb=='✛') addChildClass(treeId, nodeId, data);
            else if(lb=='✕') removeNode(treeId, nodeId, data);
            else if(lb=='✎') editNode(treeId, nodeId, data);

        }
        //表现层：事件，效果等
        function loadTableStyle(){
            $("#table1>tr>td>div.treeview>ul>li").each(function(i, d){
                $(this).find("span.badge").eq(-1).attr("title", "在该分类下添加子分类");
                $(this).find("span.badge").eq(-2).attr("title", "删除该分类及其所有子分类");
                $(this).find("span.badge").eq(-3).attr("title", "修改该分类名称或其对应值");
            });
            $("tr>td>div.newParent>span.badge").attr("title", "增加新的分类");
            $("tr>td>div.newParent>span.badge").unbind('click');
            $("tr>td>div.newParent>span.badge").on('click', function(e){
                var treeId = $(this).parent().attr('id').replace("new", "tree");
                addNewParentClass(treeId);
                //cout(__treeview_data[treeId]);
            });
            $("#table1>tr>td>div").off('click', 'ul>li>span.badge', clickNodeForOperate);
            $("#table1>tr>td>div").on('click', 'ul>li>span.badge', clickNodeForOperate);
        }

        
        function editNode(treeId, nodeId, data){
            //cout(data);

        }

        //删除节点
        function removeNode(treeId, nodeId, data){
            var unitId = treeId.match(/tree(\S*)p/)[1];
            //后台删除数据
            removeNodeServer(nodeId, 0, unitId, function(){
                var list = getChildrenListById(data, nodeId);
                list.forEach(function(d){
                    $("#ys"+d).remove();
                });
                removeNodeById(data, nodeId);       //*删除数据
                reloadTree(treeId, data);           //*重新加载
                __treeview_data[treeId] = data;     //*保存数据
            });
        }



        function loadParent(_dt){
            var dt = [{'id':1, 'name':'主要因素一', 'value':30}, {'id':2, 'name':'主要因素二', 'value':50}, {'id':3, 'name':'主要因素三', 'value':20}];
            _dt.forEach(function(d, i){
                __common_index[d.id] = i;
            });
            __common = _dt;
        }
         */
        //**********************************************服务器交互**********************************************
        //获取
        //提交
        //******************************************************************************************************
        /*
        //删除元素
        function removeNodeServer(nodeId, common, unitId, callback){
            showLoading();
            var param = {user:10001, 'nodeId':nodeId, 'common':common, 'unitId':unitId };
            ajaxData('del_performance_setting', param, function(data)
            {
                if(data.error==false){
                    callback(data.data);
                }
                hideLoading();
            }, function(){
                hideLoading();
            });
        }
        */
        //加载全部
        function loadTreeData(){
            showLoading();
            ajaxData('get_performance_common', {user:10001}, function(dt)
            {
                cout(dt.data);
                var data = dt.data;
                var tree = ViewTree.formatTree(dt.data.children);
                data['treeList'] = ViewTree.getNodeList(tree);
                var tm_table = $("#tm_table1").html();
                $("#table1").html(ejs.render(tm_table, { 'd':data }));

                var treeId = 'tree99999p0';
                ViewTree.__treeview_data[treeId] = tree;
                ViewTree.reloadTree(treeId, tree);

                hideLoading();
            }, function(){
                hideLoading();
            });
        }

        /*
        //局部刷新
        function loadLocalTreeData(unitId, parentId){
            showLoading();
            ajaxData('get_performance_setting_unit', {'unitId':unitId}, function(data){
                if(data.error==false){

                    var treeId = "tree"+ unitId + 'p' + parentId;
                    var settings = [];
                    data.data.children.forEach(function(d){ if(d.level!=1)settings.push(d); });
                    data.data.children = settings;
                    var line = getFormatUnitData(data.data);
                    __treeview_data[treeId] = line.tree[parentId];
                    reloadTree(treeId, line.tree[parentId]);

                    //****************************************************************************
                    //添加功能已搞定 - 2017-2-5


                }
                hideLoading();
            }, function(){
                hideLoading();
            });
        }

*/



        loadTreeData();

        $(document).ready(function() {

            //$("#table1>tr>td>div").on('click', 'ul>li>span.badge', clickNodeForOperate);



        });






    </script>



</xmp>