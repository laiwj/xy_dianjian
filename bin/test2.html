<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />

<link href="../css/bootstrap-theme.min.css" rel="stylesheet">
<!-- Prism -->
<link href="../css/prism.css" rel="stylesheet">

<link href="../css/footable.bootstrap.min.css" rel="stylesheet">
<link href="../css/ladda-themeless.css" rel="stylesheet">
<link href="../css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="../css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<link rel="stylesheet" href="../css/bootstrap.css" type="text/css" />
<link rel="stylesheet" href="../css/animate.css" type="text/css" />
<link rel="stylesheet" href="../css/simple-line-icons.css" type="text/css" />
<link rel="stylesheet" href="../css/font.css" type="text/css" />
<link rel="stylesheet" href="../css/app.css" type="text/css" />
<link rel="stylesheet" href="../css/public.css" type="text/css" />
<link rel="stylesheet" href="../css/bootstrap-treeview.min.css" type="text/css" />
<link rel="stylesheet" href="../css/font-awesome.min.css" type="text/css" />
</head>
<body>

<!--[if lt IE 9]>
<script src="../js/html5shiv.min.js"></script>
<script src="../js/respond.min.js"></script>
<![endif]-->
<style type="text/css">
    .bd{ border: 1px solid #ccc}
    #view1rtn{border: 1px solid #ccc; padding: 2px 18px;position:absolute;z-index:100; top:25px; cursor: pointer}
    .source{ width: 100%}

    .modal-backdrop {  opacity: 0 !important;  filter: alpha(opacity=0) !important;  }
    .center-block{  display:block;  margin-left:auto;  margin-right:auto;  }
    th,td{ border: 1px solid darkgray; background-color: white; height: auto; min-height: 30px}
    li{ height: 30px; border: 1px; padding: 0px }
    span.badge { background-color: #5bc0de}
    th{ text-align: center; height: 30px}
    tr td{ text-align: center}
    tr td.treeview{text-align: left}
    .hide{display: none}
</style>
<div CLASS="test1">1234567890</div>
<div CLASS="test1">1234567890</div>
<button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
    开始演示模态框
</button>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    模态框（Modal）标题
                </h4>
            </div>
            <div class="modal-body">
                在这里添加一些文本
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                </button>
                <button type="button" class="btn btn-primary">
                    提交更改
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>




<div id="tree1" style="width: 90%; height: 400px; border: 1px solid #ccc; margin: 5%">
    <table id="table1" style="width: 100%">


    </table>

</div>





<script src="../js/jquery-3.0.0.min.js"></script>
<script src="../js/echarts.min.js"></script>
<script src="../js/bootstrap-3.3.7.min.js"></script>
<script src="../js/bootstrap-treeview.min.js"></script>
<script src="../js/public.js"></script>
<script src="../js/prism.js"></script>
<script src="../js/ie10-viewport-bug-workaround.js"></script>
<script src="../js/moment.min.js"></script>
<script src="../js/footable.min.js"></script>
<script src="../js/spin.js"></script>
<script src="../js/ladda.js"></script>
<script src="../js/ejs.js"></script>

<script id="tm_menu1" type="text/html">
    <tr>
        <th>部门</th>
        <th colspan="<%= common.length*2 %>">绩效因素设定</th>
    </tr>
    <tr>
        <th>名称</th>
        <% common.forEach(function(d, i){ %>
            <th id="pth<%= d.id %>"><%= d.name %></th><th><%= d.value %></th>
        <% }); %>
    </tr>
    <% data.forEach(function(d, i){ %>
        <tr>
            <td id="unit<%= d.uid %>" rowspan="<%= d.maxL %>"><%= d.unit %></td>
            <% common.forEach(function(cd, ci){ %>
                <td id="tree<%= d.uid %>p<%= cd.id %>" rowspan="<%= d.maxL %>">树</td>
                <% var rsc = (cd.id in d.treeList) ? 1 : d.maxL; %>
                <% var e = (cd.id in d.treeList) ? d.treeList[cd.id][0][1] : "因素"; %>
                <% var id = (cd.id in d.treeList) ? d.treeList[cd.id][0][0] : d.uid + "p" + cd.id; %>

                <td id="ys<%= id %>" rowspan="<%= rsc %>"><%= e %></td>
            <% }); %>
        </tr>
        <% for(var j=1; j<d.maxL; j++){ %>
            <tr>
                <% common.forEach(function(cd, ci){ %>
                    <% if(!(cd.id in d.treeList))return; %>
                    <% var len = d.treeList[cd.id].length %>

                    <% if(j<len-1){ %>
                        <td id="ys<%= d.treeList[cd.id][j][0] %>"><%= d.treeList[cd.id][j][1] %></td>
                    <% }else if(j==len-1){ %>
                        <td id="ys<%= d.treeList[cd.id][j][0] %>" rowspan="<%= d.maxL-j %>"><%= d.treeList[cd.id][j][1] %></td>
                    <% } %>
                <% }); %>
            </tr>
        <% } %>

    <% }); %>

</script>


</body>
</html>

<script language="javascript">
    "use strict";


    var units = [];
    var __lsOther = {};
    var $pl;
    var __tempc = null;
    var __common = [];
    var __common_index = {};

    //树折叠事件
    function nodeCollapsed(event, data){
        var list = getNodeList(data);
        for(var i=1; i<list.length; i++){
            var obj = $("#ys"+list[i][0]);
            if(!obj.hasClass("hide"))obj.addClass("hide");
        }
    }
    //树展开事件
    function nodeExpanded(event, data){
        var list = getNodeExpanded(data);
        for(var i=0; i<list.length; i++){
            var obj = $("#ys"+list[i]);
            if(obj.hasClass("hide"))obj.removeClass("hide");
        }
    }
    //获取树展开节点
    function getNodeExpanded(tree){
        var list = [];
        tree['nodes'].forEach(function(d){
            list.push(d['id']);
        });
        return list;
    }
    function loadTable(){
        loadParent('table1');
        var lines = loadTree('table1');
        var tm_menu = $("#tm_menu1").html();
        $("#table1").html(ejs.render(tm_menu, { data:lines, common:__common }));
        lines.forEach(function(d){
            for(var p in d.tree){
                $('#tree' + d.uid + "p" + p).treeview({
                    data: d.tree[p].nodes,         // data is not optional
                    levels: getTreeHeight(d.tree[p]),
                    collapseIcon:"glyphicon glyphicon-triangle-bottom",
                    expandIcon:"glyphicon glyphicon-triangle-right",
                    color:'#643',
                    backColor: 'white',
                    showTags:true,
                    highlightSelected:false,
                    //nodeIcon:'glyphicon glyphicon-map-marker',
                    onNodeCollapsed: nodeCollapsed,
                    onNodeExpanded: nodeExpanded,
                });
                //$('#tree' + d.uid + "p" + p).treeview({

            }
        });
    }
    function loadParent(id){
        var dt = [{'id':1, 'name':'主要因素一', 'value':30},
            {'id':2, 'name':'主要因素二', 'value':50},
            {'id':3, 'name':'主要因素三', 'value':20}];
        var html = "<tr><th>部门</th>", pSize = (100/(dt.length*2 + 1)).toString() + "%";
        dt.forEach(function(d, i){
            __common_index[d.id] = i;
        });
        __common = dt;
    }
    /*
     list to tree
     input:    'children':[{'id':101, 'pid':1, 'name':'电影'}, {'id':102, 'pid':1, 'name':'购物'}, {'id':1011, 'pid':101, 'name':'日韩'}]
     output:    {"nodes":[{"id":101,"pid":1,"name":"电影","nodes":[{"id":1011,"pid":101,"name":"日韩"}]},{"id":102,"pid":1,"name":"购物"}]}
     */
    function formatTree(children){
        var lsC = {},       //节点-孩子节点列表 索引
                lsR = {},   //节点-检测是否根节点 索引
                src = {};   //节点-源数据 索引
        children.forEach(function(d){
            src[d.id] = d;
            lsR[d.id] = 1;
        });
        children.forEach(function(d){
            if(d.pid in src){
                lsR[d.id] = 0;
                if(!(d.pid in lsC))lsC[d.pid] = [];
                lsC[d.pid].push(d.id);
            }
        });
        var tree = {'nodes':[]};
        for(var c in lsR){
            if(lsR[c]==0)continue;
            var node = src[c];
            node['text'] = node['name'];
            node['tags'] = ['+', '删除', '修改'];
            tree['nodes'].push(node);
            createTree(node, lsC, src);
        }
        return tree;
    }
    //建树过程 - 递归
    function createTree(parent, lsc, src){
        if(!(parent.id in lsc))return;
        lsc[parent.id].forEach(function(d){
            if(!('nodes' in parent))parent['nodes'] = [];
            var _node = src[d];
            _node['text'] = _node['name'];
            _node['tags'] = ['+', '删除', '修改'];
            parent['nodes'].push(_node);
            createTree(_node, lsc, src);
        });
    }
    //获取树深度
    function _getTreeHeight(node, height){
        if(!('nodes' in node))return;
        height[0]++;
        node['nodes'].forEach(function(d){
            _getTreeHeight(d, height);
        });
    }
    function getTreeHeight(tree){
        var height = [0];
        _getTreeHeight(tree, height);
        return height[0];
    }
    function _getNodeList(node, list){
        if('id' in node)list.push([node['id'], node['name']]);
        if(!('nodes' in node))return;
        node['nodes'].forEach(function(d){
            _getNodeList(d, list);
        });
    }
    function getNodeList(tree){
        var list = [];
        _getNodeList(tree, list);
        return list;
    }

    function loadTree(id){
        var dt = [{'uid':100, 'unit':'科技部', 'children':[{'id':101, 'pid':1, 'name':'电影'},
            {'id':102, 'pid':1, 'name':'购物'}, {'id':1011, 'pid':101, 'name':'日韩'},
            {'id':201, 'pid':2, 'name':'自然'}, {'id':202, 'pid':2, 'name':'人文'}
        ]},
            {'uid':101, 'unit':'信息部', 'children':[{'id':111, 'pid':1, 'name':'美食'}, {'id':1110, 'pid':111, 'name':'海鲜'}, {'id':1111, 'pid':111, 'name':'火锅'}]},
            {'uid':102, 'unit':'质量部', 'children':[{'id':114, 'pid':1, 'name':'旅行'}, {'id':1140, 'pid':114, 'name':'广西'}, {'id':11401, 'pid':1140, 'name':'罗成'}
                , {'id':11402, 'pid':1140, 'name':'柳城'}
            ]},
        ];
        var data = [];
        dt.forEach(function(d){
            var line = {};
            line['unit'] = d.unit;
            line['uid'] = d.uid;
            var _tree = formatTree(d.children);
            var trees = {}, treeList = {}, maxL = 0;
            //各分树信息
            _tree.nodes.forEach(function(cd){
                if(!(cd.pid in trees))trees[cd.pid] = {'nodes':[]};
                trees[cd.pid]['nodes'].push(cd);
            });
            //各分树->列表
            __common.forEach(function(cd){
                if(cd.id in trees){
                    treeList[cd.id] = getNodeList(trees[cd.id]);
                    if(treeList[cd.id].length>maxL) maxL = treeList[cd.id].length;
                }
            });
            line['tree'] = trees;
            line['treeList'] = treeList;
            line['maxL'] = maxL;
            data.push(line);
        });
        return data;
    }

    loadTable();
    function tttt(){
        alert(2); $("tr>td span.badge").each(function(i, d){
            $(d).click(tttt);
        });

    }
    $(document).ready(function() {

        /*
        $("#table1").on('click', 'tr>td', function(){
            alert(2);
        });
         */
        $("tr>td span.badge").on('click', function(){
            cout()
            cout($("tr>td span.badge"));

        });


        $(".test1").click(function(){
            cout($("tr>td span.badge"));
        });
        /*
        $("tr>td>ul>li>span.badge").click(function(e){
            alert('ok');
        });



        var tree = [
            {
                text: "工作时间",
                nodes: [
                    {
                        text: "考勤相关",
                        //icon: "glyphicon glyphicon-edit",
                        //selectedIcon: "glyphicon glyphicon-edit",
                        //color: "#000000",
                        backColor: "white",
                        href: "#node-1",
                        selectable: true,
                        state: {
                            checked: true,
                            expanded: true,
                            selected: true
                        },
                        tags: ['available'],
                        nodes: [
                            {
                                text: "迟到"
                            },
                            {
                                text: "请假"
                            }
                        ]
                    },
                    {
                        text: "加班情况"
                    }
                ]
            },
            {
                text: "学习能力",
                nodes:[{
                    text: "主动性"
                }]
            },
            {
                text: "员工关系"
            },
            {
                text: "创新"
            },
            {
                text: "Parent 5"
            }
        ];

        $('#tree123').treeview({
            data: tree,         // data is not optional
            levels: 5,
            collapseIcon:"glyphicon glyphicon-triangle-bottom",
            expandIcon:"glyphicon glyphicon-triangle-right",
            color:'#643',
            backColor: 'white',
            //nodeIcon:'glyphicon glyphicon-map-marker',
        });

        */
    });








































</script>