<xmp>

	<link href="../css/bootstrap-theme.min.css" rel="stylesheet">
	<!-- Prism -->
	<link href="../css/prism.css" rel="stylesheet">
	<link href="../css/footable.bootstrap.min.css" rel="stylesheet">

	<!--[if lt IE 9]>
	<script src="../js/html5shiv.min.js"></script>
	<script src="../js/respond.min.js"></script>
	<![endif]-->
<style type="text/css">
td{ text-align: center}
th{ text-align: center}
.lb{ cursor: pointer; padding: 5px; font-size: 13px; padding: 5px; border: 1px solid #ccc; margin-left: 2px }
.lbf{ cursor: pointer; padding: 2px 5px; font-size: 16px; border: 1px solid #ccc;  }
.activL{ background-color: #ccc }
table tr th{background-color: #f0f0f2;border:1px solid #ccc}
table tr td{border:1px solid #ccc;}

</style>
<div class="m-sm bg-main">  
	<div class="hbox hbox-auto-xs hbox-auto-xs bg-white">
		<div class="col p-n">
			<div class="title" id="flow">办公流动分析</div>
            <div id="view1" class="w-full" style="height:380px"></div>
		</div>
	</div>

	<div class="m-t-sm hbox hbox-auto-xs hbox-auto-xs bg-white bg-auto" style="margin-top:5px; margin-bottom: 45px">
		<div class="col col-sm-12">
			<div class="title" style="height: 10px"></div>
			<div id="view3" class="w-full" style="height:395px">
			</div>
		</div>

	</div>
</div>


<script src="../js/jquery-1.9.1.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/prism.js"></script>
<script src="../js/ie10-viewport-bug-workaround.js"></script>
<script src="../js/moment.min.js"></script>
<script src="../js/footable.min.js"></script>
<script src="../js/d3.v3.min.js"></script>
<script src="../js/timePiece.js"></script>
<script src="../js/highcharts.js"></script>
	<script src="../js/echarts.v3.min.js"></script>
	<script src="../js/datazoom.js"></script>
	<script src="../js/china.js"></script>
	<script type="text/javascript" src="../js/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
	<script type="text/javascript" src="../js/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>
<script language="javascript">
"use strict";
var pieSelectName = "nosel";
var __myChart = null, __view1, __view2;
var __myChart1 = null;
var __current = 0;
var __flow_data = null;
var __table_create = false;
var __current_month = 0;
var __select_create = false;
var __datazoom_view1 = null;

$(document).ready(function() {
	var days = [ "一", "二", "三", "四", "五", "六", "日" ].map(function(d){ return "星期" + d; });
	addTimeSel("flow");
	Init();
	getFlowData('view1');


	function Init(){
		$('.form_date').datetimepicker({
			language:  'zh-CN', weekStart: 1, todayBtn:  1, autoclose: 1, todayHighlight: 1, startView: 2, minView: 2, forceParse: 0,
		}).on('changeDate', function(e){
			var startDate = $("#dtp_input2").val(), endDate = $("#dtp_input3").val();;
			getFlowData('view1', startDate, endDate);
		});
		$('.form_date:eq(0)').datetimepicker('setDate', DateDSTD(init_flow_date_start));
		$('.form_date:eq(1)').datetimepicker('setDate', DateDSTD(init_flow_date_end));
		if(!__select_create){
			loadUnitList();
			__select_create = true;
		}
	}

	//-------------------------------------加载部门信息---------------------------------------------
	function selUnit1(_u){
		var startDate = $("#dtp_input2").val(), endDate = $("#dtp_input3").val();;
		getFlowData('view1', startDate, endDate, 1, _u);
	}
	function loadUnitList(){
		ajaxData('get_units', {}, function(data)
		{
			addUnitSel('flow', data, selUnit1);
			$("#flowsel1").val(init_unit_flow);
		});
	}

	//-----------------------------------------函数部分-----------------------------------------------
	//人员流动时间段选择
	function addTimeSel(id){
		var div = '<div style="float:right">', sel1 = '<select id="'+ id + 'tsel1">',
				sel2 = '<select id="'+ id + 'tsel2">', sp = ' - ', opt='';
		for(var i=0;i<25;i++)opt += '<option value ="'+ i +'">'+ i +':00</option>';
		$("#" + id).append(div + sel1 + opt + '</select>' + sp + sel2 + opt + '</select>' + '</div>');
		$("#" + id + 'tsel1').val(8);
		$("#" + id + 'tsel2').val(9);
		$("#" + id + 'tsel1').change(timeSelClick);
		$("#" + id + 'tsel2').change(timeSelClick);
	}
	function timeSelClick(){
		loadFlowDefault();
	}

	//图1获取数据主要代码
	function getFlowData(id, dateStart, dateEnd, index, _unit){
		$("#"+id).html("");
		__datazoom_view1 = new Zoom(id);
		var lsd = days.map(function(d){ return [d, 0]; });
		__datazoom_view1.loadZoom(lsd, listenZoom);
		__view1 = __datazoom_view1.did;
		__myChart1 = echarts.init(document.getElementById(__view1)).showLoading();

		var startDate = $("#dtp_input2").val(), endDate = $("#dtp_input3").val();;
		dateStart = dateStart || startDate;
		dateEnd = dateEnd || endDate;

		var adt = {'dateStart':dateStart, 'dateEnd':dateEnd};
		var key = index ? "get_flow_unit" : "get_flow";
		if(index)adt['unit'] = _unit;
		ajaxData(key, adt, function(data)
		{
			__flow_data = data['data'];
			loadFlowDefault();
			if(!__table_create){
				createTable("view3");
				setTableHead("view3", []);
				__table_create = true;
			}
			var wkValue = getWeekdayValueSum(__flow_data);
			__datazoom_view1.setData(wkValue);
			setTableData("view3", []);
			if(__myChart1)__myChart1.hideLoading();
		});
	}
	//统计一周各天流量
	function getWeekdayValueSum(data){
		return Object.keys(data).map(function(m){
			var sum = 0;
			for(var h in data[m])
				for(var u in data[m][h])
					sum += Object.keys(data[m][h][u]).reduce(function(a, b){ return a+data[m][h][u][b]}, 0);
			return sum;
		});
	}
	function loadFlowDefault(){
		var hb = parseInt($("#flowtsel1").val()), he =parseInt( $("#flowtsel2").val()), weekday = __current;;
		loadFlowImage(__view1, weekday, hb, he);
	}
	function loadFlowImage(id, weekday, hourBegin, hourEnd){
		var cls = ['温江->成都', '成都->温江'], lsSrc = ['温江', '成都'];
		var _dt = {};
		for(var i=hourBegin; i<hourEnd; i++) {
			if(!(weekday in __flow_data))continue;
			if(!(i in __flow_data[weekday]))continue;
			for (var u in __flow_data[weekday][i]) {
				if (!(u in _dt))_dt[u] = { "温江":0, "成都":0};
				for (var src in __flow_data[weekday][i][u])_dt[u][src] += __flow_data[weekday][i][u][src];
			}
		}
		//cout(_dt);
		var units = Object.keys( _dt );
		var udata = cls.map(function(d, i){
			return units.map(function(u){ return _dt[u][lsSrc[i]]; } )
		});
		var ses = units.map(function(d, i){ return {
			barWidth:60, name:d, type:'bar', stack: '总量', data:[udata[0][i], udata[1][i]],
			itemStyle : { normal: {label : {show: true, position: 'insideRight'}}},
		}; });
		var sum1 = udata[0].reduce(function(a, b){ return a+b; }, 0),
			sum2 = udata[1].reduce(function(a, b){ return a+b; }, 0);
		var point = {data : []};
		if(sum1>0)point.data.push({name : '所有总和', value : sum1, xAxis: sum1, yAxis: 0, symbolOffset:[16, 0] });
		if(sum2>0)point.data.push({name : '所有总和', value : sum2, xAxis: sum2, yAxis: 1, symbolOffset:[16, 0] });
		if(ses.length!=0)ses[0]['markPoint'] = point;
		var lg = Object.keys(units.reduce(function(a, b, i){ if((udata[0][i]+udata[1][i])>0)a[b]=1; return a; }, {}));
		var option1 = {
			title : { subtext: '', x:'center', y:10 },
			tooltip : { axisPointer : { type : 'shadow' } },
			grid:{x2:13, x:40, y2:35 },
			legend: { y:10, data: lg ,show:false },
			calculable : true,
			xAxis : [ {name:'频次（堆积显示）', nameLocation:'middle', type : 'value', max:5+(sum1>sum2 ? sum1 : sum2) } ],
			yAxis : [{ name:'流动方向', nameLocation:'end',axisLabel:{rotate:-90,textStyle:{fontWeight:'bold',fontSize:14}}, splitLine:{show: false}, type : 'category', data : cls}],
			series : ses
		};
		//console.log(ses);
		Init3(option1, id);
	}

	//---------------------------------------------------------------------------------------------
	function listenZoom(pos, time){
		//var lsp = getProjectByTime(time[0][0], time[1][0]);
		var _tp = ['一', '二', '三', '四', '五', '六', '日'].reduce(function(a, b, i){ a[b]=i; return a;}, {})
		var d = time[0][0].substr(2);
		d = d in _tp ? _tp[d] : 0;
		__current = d;
		loadFlowDefault();;
	}


	//********************************表格相关************************************************************************************
	function getTableData(){
		var data = [], lst = [7, 8, 9, 16, 17, 18, 7, 8, 9, 16, 17, 18], lsw = [0, 1, 2, 3, 4, 5, 6];
		//cout(__flow_data);
		for(var i=0; i<lst.length; i++){
			var line = [], src = i<6 ? '成都' : '温江';
			for(var w in lsw){
				var ste = __flow_data.hasOwnProperty(w) ? __flow_data[w].hasOwnProperty(lst[i]) : false;
				line.push( !ste ? 0 : Object.keys(__flow_data[w][lst[i]]).reduce(function(a, b){
					return a + __flow_data[w][lst[i]][b][src];
				}, 0) );
			}
			data.push(line);
		}
		return data;
	}
	//加载数据
	function setTableData(id, data){
		var tp = getTableData();
		//cout(tp);
		$("#" + id + ' table tr td').each(function(d){
			var i = parseInt(d / 7), j = d % 7;
			$(this).text(tp[i][j]);
		});
	}
	//设置表头
	function setTableHead(id){
		var rth = ['07:00-08:00', '08:00-09:00', '09:00-10:00', '16:00-17:00', '17:00-18:00', '18:00-19:00']
		$("#" + id + ' table tr:first th').each(function(i){ if(i>0)$(this).text(days[i-1]); });
		$("#" + id + ' table tr:nth-child(2) th:first').text("成都->温江");
		$("#" + id + ' table tr:nth-child(8) th:first').text("温江->成都");
		for(var i=0; i<12; i++){
			var th = i%6!=0 ? 'first' : 'nth-child(2)';
			$("#" + id + ' table tr:nth-child('+ (i+2) +') th:' + th).text(rth[i%6]);
			$("#" + id + ' table tr:nth-child('+ (i+2) +') th:' + th).css("min-width", "100");
		}
	}
	//创建特殊表格
	function createTable(id){
		var view = $("#" + id), width = view.width()/9, height = (view.height()-20)/13,
				sty = ' style="border: 1px solid #ccc;width:'+ width + 'px;height:'+ height +'px"';
		var tb = '<table><tr style="border: 1px solid #ccc"><th colspan="2"></th>';
		for(var i=0; i<7; i++)tb += '<th scope="col" '+ sty +'></th>';
		for(var z=0; z<2; z++)for(var i=0; i<6; i++){
			var tp = i==0 ? 'rowspan="6"></th><th>' : '>';
			tb += '<tr style="border: 1px solid #ccc"><th '+ sty + tp + '</th>';
			for(var j=0; j<7; j++)tb += '<td'+ sty +'></td>';
			tb += '</tr>';
		}
		tb += '</table>';
		view.html(tb);
		return tb;
	}
	//------------------------------------------------------------------------------------------------------------------


});

</script>
</xmp>