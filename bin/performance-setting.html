<xmp>
    <meta charset=utf-8>

    <link rel="stylesheet" href="../css/bootstrap-treeview.min.css" type="text/css" />
    <link href="../css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Prism -->
    <link href="../css/prism.css" rel="stylesheet">
    <link href="../css/footable.bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/colorbox.css" />

    <!--[if lt IE 9]>
    <script src="../js/html5shiv.min.js"></script>
    <script src="../js/respond.min.js"></script>
    <![endif]-->

    <style type="text/css">
        th,td{ border: 1px solid #CCCCCC; background-color: white; height: auto; min-height: 30px}
        #table1 li{ height: 30px; border-bottom: 1px solid #ddd; border-right: 0px;border-left: 0px  }
        #table1 ul{ border-top: 0px }

        .key-add{color:#5cb85c}
        .key-del{color:red}
        .key-edit{color:#31b0d5}
        tr>td>div.newParent>span.badge{color:#5cb85c; cursor: pointer}
        div.treeview>ul>li>span.badge:nth-last-child(1){color:#5cb85c }
        div.treeview>ul>li>span.badge:nth-last-child(2){color:red }
        div.treeview>ul>li>span.badge:nth-last-child(3){color:#31b0d5 }

        th{ text-align: center; height: 30px}
        tr td{ min-width: 40px; }
        tr td:first-child{ text-align: center;}
        tr td.treeview{text-align: left}
        .hide{display: none}
        .td_value{ width: 100%;border-right: 0px; border-bottom:1px solid #ccc; height:30px; padding-top:10px;text-align: center;  }
        .newParent{padding-bottom: 8px; margin-top: 8px; padding-left: 38px;}


    </style>
    <div class="m-sm bg-main">
        <div class="m-t-sm hbox hbox-auto-xs hbox-auto-xs bg-white bg-auto" style="margin-top:5px; margin-bottom: 45px">
            <div class="col col-sm-12">
                <div class="title">绩效因素设定</div>
                <div id="view" class="w-full" style="min-height:395px; height: auto;">
                    <table id="table1" style="width: 100%; margin-bottom: 60px">

                    </table>
                </div>
            </div>

        </div>
    </div>


    <div style="display:none;">
        <div class="dialog-add p20 clearfix " id="dialog-add" title="任务因素与配比">
            <label>部门</label>
            <select class=" first_select">
                <option selected="selected"  value="人力资源部">人力资源部</option>
                <option value="总经理工作部">总经理工作部</option>
                <option value="财务部">财务部</option>
                <option value="市场经营部">市场经营部</option>
                <option value="档案管理部">档案管理部</option>
                <option value="综合事务部">综合事务部</option>
            </select>
            <div class="mt30">

                <label>因素与配比<i class="icon-add" id="J_add_select"></i></label>
                <div class="append-con">
                    <div class="list-li">
                        <select class="span3 second_select" style="width: 47%" >
                            <option selected="selected" value="任务">任务</option>
                            <option value="考勤">考勤</option>
                            <option value="工作时间">工作时间</option>
                            <option value="加班情况">加班情况</option>
                            <option value="员工关系">员工关系</option>
                            <option value="异常情况">异常情况</option>
                            <option value="学习能力">学习能力</option>
                            <option value="创新">创新</option>
                        </select>
                        <select class="span3 three_select" style="width: 47%">
                            <option selected="selected" value="10%">10%</option>
                            <option value="20%">20%</option>
                            <option value="30%">30%</option>
                            <option value="40%">40%</option>
                            <option value="50%">50%</option>
                            <option value="60%">60%</option>
                            <option value="70%">70%</option>
                            <option value="80%">80%</option>
                            <option value="90%">90%</option>
                            <option value="100%">100%</option>
                        </select>
                        <i class="icon-delete J_delete_add"></i>
                    </div>

                </div>
            </div>
            <button class="md-button md-accent md-dialog-btn fr mt30" id="J_save_select">开始计算</button>
        </div>
    </div>


    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/bootstrap-3.3.7.min.js"></script>
    <script src="../js/bootstrap-treeview.min.js"></script>
    <script src="../js/public.js"></script>
    <script src="../js/prism.js"></script>
    <script src="../js/ie10-viewport-bug-workaround.js"></script>
    <script src="../js/moment.min.js"></script>
    <script type="text/javascript" src="../js/jquery.colorbox-min.js" ></script>


    <script id="tm_table1" type="text/html">
        <tr>
            <th>部门</th>
            <th colspan="<%= common.length*2 %>">一级绩效因素</th>
        </tr>
        <tr>
            <th>名称</th>
            <% common.forEach(function(d, i){ %>
            <th id="pth<%= d.id %>"><%= d.name %></th><th><%= d.value %>%</th>
            <% }); %>
        </tr>

        <% data.forEach(function(d, i){ %>
        <tr>
            <td id="unit<%= d.uid %>"><%= d.unit %></td>
            <% common.forEach(function(cd, ci){ %>
            <td id="key<%= d.uid %>p<%= cd.id %>" valign="top">
                <div id="tree<%= d.uid %>p<%= cd.id %>"></div>
                <div id="new<%= d.uid %>p<%= cd.id %>" class="newParent">
                    <span class="badge">✛</span>
                </div>
            </td>
            <td id="value<%= d.uid %>p<%= cd.id %>" valign="top">
                <div>
                    <% if(!(cd.id in d.treeList))return; %>
                    <% var len = d.treeList[cd.id].length %>
                    <% for(var i=0; i<len; i++){ %>
                    <div id="ys<%= d.treeList[cd.id][i][0] %>" class="td_value"><%= d.treeList[cd.id][i][2] %>%</div>
                    <% } %>
                </div>
            </td>
            <% }); %>
        </tr>
        <% }); %>

    </script>

    <script language="javascript">
        "use strict";
        var units = [];
        var __lsOther = {};
        var $pl;
        var __tempc = null;
        var __common = [];
        var __common_index = {};
        var __treeview_data = {};       //save all data here.
        var __icons = ['✎', '✕', '✛'];

        function loadTableStyle(){
            $("#table1>tr>td>div.treeview>ul>li").each(function(i, d){
                $(this).find("span.badge").eq(-1).attr("title", "在该分类下添加子分类");
                $(this).find("span.badge").eq(-2).attr("title", "删除该分类及其所有子分类");
                $(this).find("span.badge").eq(-3).attr("title", "修改该分类名称或其对应值");
            });
            $("tr>td>div.newParent>span.badge").attr("title", "增加新的分类");
            $("tr>td>div.newParent>span.badge").unbind('click');
            $("tr>td>div.newParent>span.badge").on('click', function(e){
                var treeId = $(this).parent().attr('id').replace("new", "tree");
                addNewParentClass(treeId);
                //cout(__treeview_data[treeId]);
            });
            $("#table1>tr>td>div").off('click', 'ul>li>span.badge', clickNodeForOperate);
            $("#table1>tr>td>div").on('click', 'ul>li>span.badge', clickNodeForOperate);
        }
        /*
         ********************************************************************************************
         * 操作相关处理函数聚集
         ********************************************************************************************
         */
        function clickNodeForOperate(e){
            var treeId = $(this).parents("div.treeview").attr('id');
            var nodeId = $(this).parent().find("a").attr("href").replace("#node-", "");
            var lb = $(this).html();        //['✎', '✕', '✛'];
            var data = __treeview_data[treeId];

            if(lb=='✛') addChildClass(treeId, nodeId, data);
            else if(lb=='✕') removeNode(treeId, nodeId, data);
            else if(lb=='✎') editNode(treeId, nodeId, data);

        }
        function _removeTreeView(treeId){
            var p = $("#" + treeId).parent();
            if($("#" + treeId).hasClass("treeview")){
                $('#'+treeId).data('treeview').remove();
                $("#" + treeId).treeview("remove");
                $("#" + treeId).removeClass("treeview");
                $("#" + treeId).empty();
            }
            $("#" + treeId).remove();
            p.prepend('<div id="'+ treeId +'"></div>');
        }
        function reloadTree(treeId, data){
            _removeTreeView(treeId);
            if(!('nodes' in data))return;
            var option = getTreeOption();
            option['data'] = data.nodes;         // data is not optional
            option['levels'] = getTreeHeight(data);
            $("#" + treeId).treeview(option);
            loadTableStyle();

        }
        //局部因素刷新：tree + 因素值
        function reloadLocalTree(treeId, data){
            reloadTree(treeId, data);
            var Id = treeId.replace("tree", "");

            var list = getNodeList(data);
            var html = "<div>";
            for(var i=0; i<list.length; i++)html += '<div id="ys' + list[i][0] + '"' + ' class="td_value">10%</div>';
            html += "</div>";
            $("#value" + Id).html(html);

            /*
                <div>
                    <% if(!(cd.id in d.treeList))return; %>
                    <% var len = d.treeList[cd.id].length %>
                    <% for(var i=0; i<len; i++){ %>
                    <div id="ys<%= d.treeList[cd.id][i][0] %>" class="td_value">10%</div>
                    <% } %>
                </div>
            */
        }
        function editNode(treeId, nodeId, data){
            //cout(data);

        }
        //删除节点
        function removeNode(treeId, nodeId, data){
            var list = getChildrenListById(data, nodeId);
            list.forEach(function(d){
                $("#ys"+d).remove();
            });
            //********************************************
            //*后台删除数据
            //*

            removeNodeById(data, nodeId);       //*删除数据
            reloadTree(treeId, data);           //*重新加载
            __treeview_data[treeId] = data;     //*保存数据
        }
        function addChildClass(treeId, nodeId, data){
            var newData = [];
            ajaxData('get_performance_setting_unit', {}, function(data){

            });

        }
        function addNewParentClass(treeId){
            var dt = {'userId':10001, 'unitId':'10024', 'style':1};

            //showLoading();

            //hideLoading();

            loadNewFrame();

            return;
            ajaxData('change_performance_setting', dt, function(data){


                cout(data);
                //******************************************************
                //此处实际用get方法


            });

        }

        function loadNewFrame(){
            cout("loading");
            $.colorbox({
                title:'绩效设置相关', opacity:0.8, overlayClose:false,escKey:false, inline:false, speed:0,
                html:'<div style="border:0px #ccc solid ;width:400px; height:200px"><h1>Welcome</h1><h1>Welcome</h1><h1>Welcome</h1><h1>Welcome</h1></div>',
                onComplete:function(){
                    $("#cboxWrapper").css("border", "5px solid #bbb");
                    $("#cboxWrapper").css("background-color", "#bbb");
                    $("#cboxClose").css("margin", "-5px 10px 10px 0px");
                }
            });
            //*************************************************************
            //弹出效果搞定






            

            /*
            $(".J_edit").colorbox({inline:true,href:"#dialog-add",title:'任务因素与配比',innerWidth:510,initialHeight:700,
                onOpen:function(){
                    alert(123);
                    $(".append-con  .list-li").not(":first").remove();
                    $("#J_add_select").on('click',function(){
                        $(".append-con").append('<div class="list-li">'+
                                '<select class="span3 second_select" style="margin-right: 3px;width: 47%;">'+
                                '<option value="任务">任务</option>'+
                                '<option value="考勤">考勤</option>'+
                                '<option value="工作时间">工作时间</option>'+
                                '<option value="加班情况">加班情况</option>'+
                                '<option value="员工关系">员工关系</option>'+
                                '<option value="异常情况">异常情况</option>'+
                                '<option value="学习能力">学习能力</option>'+
                                '<option value="创新">创新</option>'+
                                '</select>'+
                                '<select class="span3 three_select" style="width: 47%;">'+
                                '<option selected="selected" value="10%">10%</option>'+
                                '<option value="20%">20%</option>'+
                                '<option value="30%">30%</option>'+
                                '<option value="100%">100%</option>'+
                                '</select>'+
                                '<i class="icon-delete J_delete_add" ></i>'+
                                '</div>');
                        $.colorbox.resize();
                        $(".J_delete_add").on("click",function(){
                            $(this).parent('.list-li').remove();
                            $.colorbox.resize();
                        });
                    });

                }
            });
            */
        }

        /*
         ********************************************************************************************
         * 树折叠相关
         */
        //树折叠事件
        function nodeCollapsed(event, data){
            var list = getNodeList(data);
            for(var i=1; i<list.length; i++){
                var obj = $("#ys"+list[i][0]);
                if(!obj.hasClass("hide"))obj.addClass("hide");
            }
        }
        //树展开事件
        function nodeExpanded(event, data){
            var list = getNodeExpanded(data);
            for(var i=0; i<list.length; i++){
                var obj = $("#ys"+list[i]);
                if(obj.hasClass("hide"))obj.removeClass("hide");
            }
        }
        //获取树展开节点
        function getNodeExpanded(tree){
            var list = [];
            tree['nodes'].forEach(function(d){
                list.push(d['id']);
            });
            return list;
        }
        //*********************************************************************************************
        function getTreeOption(){
            return {
                collapseIcon:"glyphicon glyphicon-triangle-bottom",
                expandIcon:"glyphicon glyphicon-triangle-right",
                color:'#643',
                backColor: 'white',
                showTags:true,
                highlightSelected:false,
                enableLinks: true,
                //nodeIcon:'glyphicon glyphicon-map-marker',
                onNodeCollapsed: nodeCollapsed,
                onNodeExpanded: nodeExpanded,
            };
        }

        function loadTable(){
            loadParent('table1');
            var lines = loadTree('table1');
            var tm_menu = $("#tm_table1").html();
            $("#table1").html(ejs.render(tm_menu, { data:lines, common:__common }));
            lines.forEach(function(d){
                for(var p in d.tree){
                    var treeId = 'tree' + d.uid + "p" + p;
                    __treeview_data[treeId] = d.tree[p];
                    reloadTree(treeId, d.tree[p]);

                }
            });
            //loadTableStyle();

            //$("ul>li>span.badge").eq(-2).addClass("key-add");
            //cout($("ul>li>span.badge"));
        }
        function loadParent(_dt){
            var dt = [{'id':1, 'name':'主要因素一', 'value':30}, {'id':2, 'name':'主要因素二', 'value':50}, {'id':3, 'name':'主要因素三', 'value':20}];
            _dt.forEach(function(d, i){
                __common_index[d.id] = i;
            });
            __common = _dt;
        }
        /*
         list to tree
         input:    'children':[{'id':101, 'pid':1, 'name':'电影'}, {'id':102, 'pid':1, 'name':'购物'}, {'id':1011, 'pid':101, 'name':'日韩'}]
         output:    {"nodes":[{"id":101,"pid":1,"name":"电影","nodes":[{"id":1011,"pid":101,"name":"日韩"}]},{"id":102,"pid":1,"name":"购物"}]}
         */
        function formatTree(children){
            var lsC = {},       //节点-孩子节点列表 索引
                    lsR = {},   //节点-检测是否根节点 索引
                    src = {};   //节点-源数据 索引
            children.forEach(function(d){
                src[d.id] = d;
                lsR[d.id] = 1;
            });
            children.forEach(function(d){
                if(d.pid in src){
                    lsR[d.id] = 0;
                    if(!(d.pid in lsC))lsC[d.pid] = [];
                    lsC[d.pid].push(d.id);
                }
            });

            var tree = {'nodes':[]};
            for(var c in lsR){
                if(lsR[c]==0)continue;
                var node = src[c];
                node['text'] = node['name'];
                node['tags'] = __icons;
                node['href'] = "#node-" + node['id'];   //日后方便找到
                tree['nodes'].push(node);
                createTree(node, lsC, src);
            }
            return tree;
        }
        //建树过程 - 递归
        function createTree(parent, lsc, src){
            if(!(parent.id in lsc))return;
            lsc[parent.id].forEach(function(d){
                if(!('nodes' in parent))parent['nodes'] = [];
                var _node = src[d];
                _node['text'] = _node['name'];
                _node['tags'] = __icons;
                _node['href'] = "#node-" + _node['id'];   //日后方便找到
                parent['nodes'].push(_node);
                createTree(_node, lsc, src);
            });
        }
        //获取树深度
        function _getTreeHeight(node, height){
            if(!('nodes' in node))return;
            height[0]++;
            node['nodes'].forEach(function(d){
                _getTreeHeight(d, height);
            });
        }
        function getTreeHeight(tree){
            var height = [0];
            _getTreeHeight(tree, height);
            return height[0];
        }
        function _getNodeList(node, list){
            if('id' in node)list.push([node['id'], node['name'], node['value']]);
            if(!('nodes' in node))return;
            node['nodes'].forEach(function(d){
                _getNodeList(d, list);
            });
        }
        function getNodeList(tree){
            var list = [];
            _getNodeList(tree, list);
            return list;
        }
        //获取子孙节点
        //*注：此算法未经深入验证
        function _getChildrenListById(node, id, list, flag){
            if(flag==true)list.push(node['id']);
            if(!('nodes' in node))return;
            node['nodes'].forEach(function(d){
                if(d['id']==id)
                    _getChildrenListById(d, id, list, true);
                else
                    _getChildrenListById(d, id, list, flag);
            });
        }
        function getChildrenListById(tree, id){
            var list = [];
            _getChildrenListById(tree, id, list, false);
            return list;
        }
        //删除节点·含子树
        function removeNodeById(node, id){
            if(!('nodes' in node))return;
            for(var i=0; i<node['nodes'].length; i++){
                if(node['nodes'][i]['id']==id){
                    node['nodes'].splice(i, 1);
                    if(node['nodes'].length==0)delete node['nodes'];
                    return;
                }
                removeNodeById(node['nodes'][i], id);
            }
        }
        /*
         function removeNodeById(tree, id){
         for(var i=0; i<tree['nodes'].length; i++){
         if(tree['nodes'][i]['id']==id){
         tree['nodes'].splice(i, 1);
         if(tree['nodes'].length==0)delete tree['nodes'];
         return;
         }
         _removeNodeById(tree['nodes'][i], id);
         }
         }
         function _removeNodeById(node, id){
         if(!('nodes' in node))return;
         for(var i=0; i<node['nodes'].length; i++){
         if(node['nodes'][i]['id']==id){
         node['nodes'].splice(i, 1);
         if(node['nodes'].length==0)delete node['nodes'];
         return;
         }
         _removeNodeById(node['nodes'][i], id);
         }
         }

         */

        function loadTreeData(){
            ajaxData('get_all_performance_setting', {user:10001}, function(data)
            {
                loadParent(data.common);
                var lines = loadTree(data.setting);
                var tm_table = $("#tm_table1").html();
                $("#table1").html(ejs.render(tm_table, { data:lines, common:__common }));
                lines.forEach(function(d){
                    for(var p in d.tree){
                        var treeId = 'tree' + d.uid + "p" + p;
                        __treeview_data[treeId] = d.tree[p];
                        reloadTree(treeId, d.tree[p]);

                    }

                });

                //cout(data.setting);
                cout(lines);
                cout(__common);
                //loadTree(data);

            });
        }
        function loadTree(_dt){
            var dt = [{'uid':100, 'unit':'科技部', 'children':[{'id':101, 'pid':1, 'name':'电影'},
                {'id':102, 'pid':1, 'name':'购物'}, {'id':1011, 'pid':101, 'name':'日韩'},
                {'id':201, 'pid':2, 'name':'自然'}, {'id':202, 'pid':2, 'name':'人文'}
            ]},
                {'uid':101, 'unit':'信息部', 'children':[{'id':111, 'pid':1, 'name':'美食'}, {'id':1110, 'pid':111, 'name':'海鲜'}, {'id':1111, 'pid':111, 'name':'火锅'}]},
                {'uid':102, 'unit':'质量部', 'children':[{'id':114, 'pid':1, 'name':'旅行'}, {'id':1140, 'pid':114, 'name':'广西'}, {'id':11401, 'pid':1140, 'name':'罗成'}
                    , {'id':11402, 'pid':1140, 'name':'柳城'}
                ]},
            ];
            var data = [];
            _dt.forEach(function(d){
                var line = {};
                line['unit'] = d.unit;
                line['uid'] = d.uid;
                var _tree = formatTree(d.children);
                var trees = {}, treeList = {}, maxL = 0;
                //各分树信息
                _tree.nodes.forEach(function(cd){
                    if(!(cd.pid in trees))trees[cd.pid] = {'nodes':[]};
                    trees[cd.pid]['nodes'].push(cd);
                });
                //各分树->列表
                __common.forEach(function(cd){
                    if(cd.id in trees){
                        treeList[cd.id] = getNodeList(trees[cd.id]);
                        if(treeList[cd.id].length>maxL) maxL = treeList[cd.id].length;
                    }
                });
                line['tree'] = trees;
                line['treeList'] = treeList;
                line['maxL'] = maxL;
                data.push(line);
            });
            return data;
        }


        //loadTable();
        loadTreeData();

        $(document).ready(function() {

            //$("#table1>tr>td>div").on('click', 'ul>li>span.badge', clickNodeForOperate);



        });






    </script>



</xmp>